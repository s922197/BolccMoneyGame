<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾ç•œç”Ÿå­˜æˆ°ï¼šç†è²¡ Roguelike v2.9 (è‚¡ç¥¨èˆ‡ç”Ÿæ´»è²»èª¿æ•´)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --bg: #ecf0f1;
            --card-bg: #fff;
            /* èª¿æ•´åŸºç¤å­—é«”å¤§å° */
            font-size: 18px; /* åŸºç¤å­—é«”æ”¾å¤§ */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 15px; /* å¢åŠ æ•´é«”é‚Šè· */
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
        }
        .container {
            max-width: 1400px; /* ç¨å¾®å¢åŠ æœ€å¤§å¯¬åº¦ */
            width: 100%;
        }
        
        /* æ¨™é¡Œèˆ‡æŒ‰éˆ•æ”¾å¤§ */
        #setup-screen h1 { font-size: 2.5em; }
        #setup-screen h3 { font-size: 1.5em; }
        #setup-screen p { font-size: 1.1em; }
        .confirm-btn {
            padding: 15px 50px;
            font-size: 1.4em;
            /* æ–°å¢æ¨£å¼ï¼Œç”¨æ–¼ç¢ºèªæŒ‰éˆ•çš„ç¦ç”¨ç‹€æ…‹ */
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 0 #1e8449;
            transition: all 0.1s;
        }
        .confirm-btn:active { transform: translateY(4px); box-shadow: none; }
        .confirm-btn:disabled {
            background: #95a5a6;
            box-shadow: 0 4px 0 #7f8c8d;
            cursor: not-allowed;
            transform: translateY(0);
        }

        /* å„€è¡¨æ¿ - å¼·åˆ¶å°é½Šå’Œç­‰å¯¬ */
        .dashboard {
            display: flex;
            justify-content: space-between;
            gap: 15px; 
            margin-bottom: 20px;
        }
        .player-stats {
            background: var(--card-bg);
            padding: 15px 20px; 
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            
            flex-basis: 0;
            flex-grow: 1; 
            
            border-top: 5px solid #bdc3c7;
            transition: all 0.3s;
            position: relative;
        }
        .player-stats h3 { font-size: 1.4em; margin-top: 0; margin-bottom: 10px; }
        .player-stats.active {
            border-top-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }
        
        /* æ•¸å€¼é¡¯ç¤º */
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0; 
            font-size: 1.1em; 
            align-items: center;
        }
        .money { 
            color: var(--accent); 
            font-weight: bold; 
            font-family: monospace; 
            font-size: 1.2em; 
        }
        .debt { color: var(--danger); font-weight: bold; }
        
        /* å¥åº·æ¢ */
        .hp-bar-bg { width: 100px; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; }
        .hp-bar-fill { height: 100%; transition: width 0.5s, background 0.5s; }

        /* éŠæˆ²è³‡è¨Šèˆ‡éšæ®µ */
        .phase-indicator {
            text-align: center;
            font-size: 1.4em; 
            font-weight: bold;
            color: #d35400;
            margin: 15px 0;
            background: #fad7a0;
            padding: 8px;
            border-radius: 5px;
        }

        /* å¡ç‰Œå€åŸŸ - ç¢ºä¿å–®è¡Œé¡¯ç¤º */
        .cards-area {
            display: flex; /* æ”¹ç‚º Flex ä½ˆå±€ */
            gap: 20px;
            margin-bottom: 20px;
            justify-content: space-between; /* å‡å‹»åˆ†ä½ˆ */
        }
        .card {
            background: var(--card-bg);
            border: 3px solid #eee; /* åŠ ç²—é‚Šæ¡† */
            border-radius: 8px;
            padding: 15px; 
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px; 
            position: relative;

            flex-basis: 0; /* ç¢ºä¿ç­‰å¯¬ */
            flex-grow: 1; 
            flex-shrink: 1;
            min-width: 0; /* å…è¨±ç¸®å° */
        }
        .card:hover { transform: translateY(-3px); border-color: #bdc3c7; }
        
        /* æ–°å¢ï¼šé¸ä¸­ç‹€æ…‹ */
        .card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.7);
            transform: translateY(-5px);
        }

        .card.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .card-title { font-weight: bold; color: #2980b9; font-size: 1.3em; line-height: 1.2; }
        .card-desc { font-size: 1em; color: #555; line-height: 1.4; flex-grow: 1; }
        
        /* æ¨™ç±¤ */
        .tag {
            font-size: 0.8em; 
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
        .tag-job { background: #3498db; }
        .tag-risk-low { background: #27ae60; }
        .tag-risk-mid { background: #f39c12; }
        .tag-risk-high { background: #c0392b; }
        .tag-none { background: #95a5a6; }
        .tag-special { background: #8e44ad; }

        /* äº‹ä»¶æ—¥èªŒå„ªåŒ– */
        .log-area {
            background: #fff;
            padding: 20px; 
            border-radius: 8px;
            height: 200px; 
            overflow-y: auto;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 1.1em; 
        }
        .log-area h3 { font-size: 1.3em; }
        .log-entry { margin-bottom: 7px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .log-turn { color: #fff; background: #e67e22; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
        .log-bad { color: #c0392b; font-weight: bold; }
        .log-good { color: #27ae60; font-weight: bold; }

        /* ç‹€æ…‹æ–‡å­—å°å­— */
        .status-text { font-size: 0.9em; color: #7f8c8d; margin-top: 5px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen" style="text-align: center; margin-top: 50px;">
        <h1>ğŸ¥ ç¤¾ç•œç”Ÿå­˜æˆ° Roguelike</h1>
        <h3>ç†è²¡ x å¥åº· x éš¨æ©Ÿäº‹ä»¶</h3>
        <div style="background: white; padding: 20px; border-radius: 10px; display: inline-block; text-align: left;">
            <p>âœ… <b>ç›®æ¨™ï¼š</b>20 è¼ªå¾Œç¸½è³‡ç”¢æœ€é«˜è€…ç²å‹</p>
            <p>âœ… <b>è¦å‰‡ï¼š</b>æ¯è¼ªå¾ 5 å€‹é¸é …ä¸­**é¸æ“‡ 1 æˆ– 2 å€‹**åŸ·è¡Œ</p>
            <p>â¤ï¸ <b>å¥åº·ï¼š</b>å·¥æ™‚éé•·(>8hr)æœƒæ‰£å¥åº·ï¼Œå¥åº·ä½å®¹æ˜“ç”Ÿç—…ç ´è²¡</p>
            <p>ğŸ’¼ <b>å·¥ä½œï¼š</b>ç©©å®šå·¥ä½œåªèƒ½ä¸€ä»½ï¼Œå¯éš¨æ™‚è¢«æ–°å·¥ä½œæ›¿æ›</p>
        </div>
        <br><br>
        <button class="confirm-btn" onclick="startGame()">é–‹å§‹å°æŠ—</button>
    </div>

    <div id="game-screen" style="display: none;">
        <div class="phase-indicator">
            <span id="turn-display">æº–å‚™ä¸­...</span> | <span id="phase-msg"></span>
        </div>

        <div class="dashboard">
            <div class="player-stats" id="p1-stats">
                <h3>ğŸ‘¨â€ğŸ’¼ A çµ„</h3>
                <div class="stat-row">
                    <span>ç¾é‡‘/å­˜æ¬¾</span>
                    <span><span class="money" id="p1-cash">$100</span> / <span class="money" id="p1-bank">$0</span></span>
                </div>
                <div class="stat-row">
                    <span>å¥åº·å€¼</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span id="p1-hp-text">100</span>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" id="p1-hp-bar" style="width:100%; background:#27ae60;"></div></div>
                    </div>
                </div>
                <div class="stat-row">åˆ©ç‡: <span class="money" style="color:#8e44ad" id="p1-rate">1.0%</span></div>
                <div class="status-text" id="p1-status">ç„¡å·¥ä½œ</div>
            </div>

            <div class="player-stats" id="p2-stats">
                <h3>ğŸ‘©â€ğŸ’» B çµ„</h3>
                <div class="stat-row">
                    <span>ç¾é‡‘/å­˜æ¬¾</span>
                    <span><span class="money" id="p2-cash">$100</span> / <span class="money" id="p2-bank">$0</span></span>
                </div>
                <div class="stat-row">
                    <span>å¥åº·å€¼</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span id="p2-hp-text">100</span>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" id="p2-hp-bar" style="width:100%; background:#27ae60;"></div></div>
                    </div>
                </div>
                <div class="stat-row">åˆ©ç‡: <span class="money" style="color:#8e44ad" id="p2-rate">1.0%</span></div>
                <div class="status-text" id="p2-status">ç„¡å·¥ä½œ</div>
            </div>
        </div>

        <div id="cards-container" class="cards-area"></div>

        <div class="action-area" style="text-align: center; margin-top: 20px;">
            <button class="confirm-btn" id="confirm-btn" onclick="confirmAction()" disabled>ç¢ºèªè¡Œå‹• (è«‹é¸æ“‡ 1-2 å¼µå¡)</button>
        </div>

        <h3>ğŸ“ äº‹ä»¶æ—¥èªŒ</h3>
        <div class="log-area" id="game-log"></div>
    </div>
</div>

<script>
const CONFIG = {
    maxTurns: 20,
    startCash: 100,
    livingCost: 30, // æé«˜ç”Ÿæ´»è²»
    titheRate: 0.1,
    baseRate: 0.01,
    startHp: 100,
    maxHp: 100,
    safeHours: 8, 
    overworkPenalty: 3, 
    turnsPerMonth: 4,
    turnSalaryIncrease: 0.02 // æ¯è¼ªè–ªæ°´å¢åŠ  2%
};

let gameState = {
    turn: 1,
    phase: 'p1_choice', 
    players: [],
    currentCards: [],
    selectedIndices: [], 
    maxSelections: 1 
};

// --- åˆå§‹åŒ– ---
function createPlayer(name) {
    return {
        name: name,
        cash: CONFIG.startCash,
        bank: 0,
        rate: CONFIG.baseRate,
        tempRateBoost: { amount: 0, turnsLeft: 0 }, // çµæ§‹èª¿æ•´ç‚ºç‰©ä»¶
        hp: CONFIG.startHp,
        stableJob: null, 
        partTimeJobs: [], 
        investments: [],
        lockedSavings: [], 
        stocks: [], // æ–°å¢ï¼šè‚¡ç¥¨æŒæœ‰
        roundIncome: 0
    };
}

function startGame() {
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    
    gameState.turn = 1;
    gameState.players = [createPlayer('A çµ„'), createPlayer('B çµ„')];
    
    log("=== éŠæˆ²é–‹å§‹ ===", 'turn');
    log("ç¬¬ 1 è¼ª (T1) åªèƒ½é¸æ“‡ 1 å¼µå·¥ä½œå¡ã€‚ç”Ÿæ´»è²»èª¿æ•´ç‚º $30ã€‚");
    
    startPlayerTurn(0);
}

// --- éŠæˆ²æµç¨‹æ§åˆ¶ ---
function startPlayerTurn(playerIdx) {
    gameState.phase = playerIdx === 0 ? 'p1_choice' : 'p2_choice';
    gameState.selectedIndices = []; 
    
    // æ±ºå®šæœ¬è¼ªæœ€å¤§é¸æ“‡æ•¸
    if (gameState.turn === 1) {
        gameState.maxSelections = 1; 
    } else {
        gameState.maxSelections = 2; 
    }

    updateUI();
    generateCards(playerIdx);
    
    // é‡è¨­ç¢ºèªæŒ‰éˆ•ç‹€æ…‹
    const btn = document.getElementById('confirm-btn');
    btn.disabled = true;
    btn.innerText = `ç¢ºèªè¡Œå‹• (è«‹é¸æ“‡ 1-${gameState.maxSelections} å¼µå¡)`;

    // ç¢ºä¿æ‰€æœ‰å¡ç‰‡éƒ½å¯é»æ“Š
    document.querySelectorAll('.card').forEach(card => card.classList.remove('disabled', 'selected'));
}

function handleCardClick(index) {
    const btn = document.getElementById('confirm-btn');
    const cardElement = document.getElementById(`card-${index}`);
    const card = gameState.currentCards[index];
    const playerIdx = gameState.phase === 'p1_choice' ? 0 : 1;
    const player = gameState.players[playerIdx];

    // å­˜æ¬¾ç‰¹æ®Šè™•ç†ï¼šç›´æ¥å½ˆå‡º Prompt é€²è¡Œé¸æ“‡ï¼Œä¸é€²å…¥é¸ä¸­ç‹€æ…‹
    if (card.title === 'ğŸ’° å½ˆæ€§å­˜æ¬¾') {
        // å…ˆå°‡æ‰€æœ‰å¡ç‰‡è¨­ç‚º disabledï¼Œé¿å…ç©å®¶åœ¨ prompt å½ˆçª—æ™‚äº‚é»
        document.querySelectorAll('.card').forEach(c => c.classList.add('disabled'));

        let input = prompt("è«‹è¼¸å…¥å­˜æ¬¾æ¯”ä¾‹ï¼š20 (20%) / 50 (50%) / ALL (å…¨éƒ¨)");
        
        // é‡æ–°å•Ÿç”¨å¡ç‰‡ï¼Œè®“ç©å®¶å¯ä»¥é‡æ–°é¸æ“‡
        document.querySelectorAll('.card').forEach(c => c.classList.remove('disabled'));

        if (input) {
            input = input.toUpperCase().trim();
            
            let amtToDeposit = 0;
            if (input === 'ALL') {
                amtToDeposit = player.cash;
            } else {
                const percentage = parseInt(input);
                if (percentage === 20 || percentage === 50) {
                    amtToDeposit = Math.floor(player.cash * (percentage / 100));
                }
            }

            if (amtToDeposit > 0) {
                // è‡ªå‹•å°‡å­˜æ¬¾å¡é¸ä¸­ä¸¦ç¢ºèª
                gameState.selectedIndices = [index];
                card.effect(player, amtToDeposit); // åŸ·è¡Œå¸¶åƒæ•¸çš„æ•ˆæœ
                confirmAction(true); // å¼·åˆ¶è§¸ç™¼ç¢ºèª
                return;
            }
        }
        log(`âš ï¸ ${player.name} å–æ¶ˆæˆ–ç„¡æ•ˆçš„å­˜æ¬¾é¸æ“‡ã€‚`, 'bad');
        return;
    }


    // æ­£å¸¸é¸æ“‡é‚è¼¯
    const idx = gameState.selectedIndices.indexOf(index);

    if (idx > -1) {
        // å–æ¶ˆé¸æ“‡
        gameState.selectedIndices.splice(idx, 1);
        cardElement.classList.remove('selected');
    } else {
        // é¸æ“‡
        if (gameState.selectedIndices.length < gameState.maxSelections) {
            gameState.selectedIndices.push(index);
            cardElement.classList.add('selected');
        } else {
            log(`âš ï¸ æœ€å¤šåªèƒ½é¸æ“‡ ${gameState.maxSelections} å¼µå¡ç‰‡ï¼`, 'bad');
            return;
        }
    }
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹å’Œæ–‡å­—
    if (gameState.selectedIndices.length >= 1) {
        btn.disabled = false;
        btn.innerText = `ç¢ºèªè¡Œå‹• (${gameState.selectedIndices.length} / ${gameState.maxSelections})`;
    } else {
        btn.disabled = true;
        btn.innerText = `ç¢ºèªè¡Œå‹• (è«‹é¸æ“‡ 1-${gameState.maxSelections} å¼µå¡)`;
    }
}

function confirmAction(isQuickAction = false) {
    const playerIdx = gameState.phase === 'p1_choice' ? 0 : 1;
    const player = gameState.players[playerIdx];

    if (!isQuickAction && (gameState.selectedIndices.length < 1 || gameState.selectedIndices.length > gameState.maxSelections)) {
         log(`âš ï¸ ${player.name} å¿…é ˆé¸æ“‡ 1 åˆ° ${gameState.maxSelections} å¼µå¡ç‰‡ï¼`, 'bad');
         return;
    }

    // ç¦ç”¨æŒ‰éˆ•å’Œå¡ç‰‡ï¼Œé˜²æ­¢äºŒæ¬¡æ“ä½œ
    document.getElementById('confirm-btn').disabled = true;
    document.querySelectorAll('.card').forEach(card => card.classList.add('disabled'));
    
    // åŸ·è¡Œå¡ç‰Œæ•ˆæœ
    let executionLog = `${player.name} åŸ·è¡Œäº† ${gameState.selectedIndices.length} é …è¡Œå‹•: `;
    let results = [];
    
    // åŸ·è¡Œé¸ä¸­çš„å¡ç‰Œæ•ˆæœ
    gameState.selectedIndices.forEach(index => {
        const card = gameState.currentCards[index];
        
        // é‡å°éå­˜æ¬¾å¡ï¼Œæ•ˆæœåŸ·è¡Œä¸éœ€è¦é¡å¤–åƒæ•¸
        if (card.title !== 'ğŸ’° å½ˆæ€§å­˜æ¬¾') {
            const result = card.effect(player);
            results.push(`[${card.title}] - ${result}`);
        } else {
             // å­˜æ¬¾å¡çš„æ•ˆæœå·²ç¶“åœ¨ handleCardClick ä¸­åŸ·è¡Œä¸¦æ—¥èªŒè¨˜éŒ„ï¼Œé€™è£¡åªè¨˜éŒ„ title
             results.push(`[${card.title}] - å·²åŸ·è¡Œ`);
        }
    });

    log(executionLog + results.join(' | '));
    
    // æ¸…ç©ºé¸æ“‡
    gameState.selectedIndices = [];
    
    // è½‰æ›è‡³ä¸‹ä¸€ç©å®¶/è¼ªæ¬¡
    setTimeout(() => {
        if (playerIdx === 0) {
            startPlayerTurn(1); // æ› B çµ„
        } else {
            gameState.phase = 'processing';
            updateUI();
            document.getElementById('cards-container').innerHTML = '<h3 style="text-align:center;width:100%;color:#aaa;">çµç®—ä¸­...</h3>';
            setTimeout(processTurn, 800); // çµç®—
        }
    }, 500);
}


// --- å¡ç‰Œç”Ÿæˆå™¨ ---

// è¨ˆç®—å‹•æ…‹è–ªæ°´
function getDynamicPay(basePay) {
    if (gameState.turn === 1) return basePay;
    
    const increaseFactor = 1 + (gameState.turn - 1) * CONFIG.turnSalaryIncrease;
    return Math.floor(basePay * increaseFactor / 10) * 10; // å–æ•´å
}

const generators = {
    // ç©©å®šå·¥ä½œé¡ (æ›¿æ›åˆ¶)
    jobStableStandard: () => {
        const basePay = 200;
        const pay = getDynamicPay(basePay);
        return {
            title: 'ğŸ’¼ ä¸€èˆ¬è·å“¡',
            tag: 'ç©©å®šå·¥ä½œ',
            desc: `æ¨™æº–å·¥æ™‚ **8 å°æ™‚**ã€‚æ¯è¼ªæ”¶å…¥ $${pay}ã€‚`,
            effect: (p) => {
                p.stableJob = { name: 'ä¸€èˆ¬è·å“¡', pay: pay, hours: 8, desc: '8hr/æ—¥' };
                return 'ç²å¾—ç©©å®šå·¥ä½œ (8hr/æ—¥)';
            }
        };
    },
    jobStableShift: () => {
        const basePay = 300;
        const pay = getDynamicPay(basePay);
        return {
            title: 'ğŸ­ ç”¢ç·šä½œæ¥­å“¡',
            tag: 'åšäºŒä¼‘äºŒ',
            desc: `æ¯æ—¥ **10 å°æ™‚**ã€‚é«˜è–ªä½†æœ‰éå‹é¢¨éšªã€‚æ¯è¼ªæ”¶å…¥ $${pay}ã€‚`,
            effect: (p) => {
                p.stableJob = { name: 'ä½œæ¥­å“¡(åšäºŒä¼‘äºŒ)', pay: pay, hours: 10, desc: '10hr/æ—¥(å‡)' };
                return 'ç²å¾—é«˜å·¥æ™‚å·¥ä½œ (10hr/æ—¥)';
            }
        };
    },
    jobStableOvertime: () => {
        const basePay = 450;
        const pay = getDynamicPay(basePay);
        return {
            title: 'ğŸ’» è²¬ä»»åˆ¶å·¥ç¨‹å¸«',
            tag: 'çˆ†è‚',
            desc: `æ¯æ—¥ **12 å°æ™‚**ã€‚æ¥µé«˜æ”¶å…¥ä½†å¥åº·æ‰£æåš´é‡ã€‚æ¯è¼ªæ”¶å…¥ $${pay}ã€‚`,
            effect: (p) => {
                p.stableJob = { name: 'è²¬ä»»åˆ¶å·¥ç¨‹å¸«', pay: pay, hours: 12, desc: '12hr/æ—¥' };
                return 'ç²å¾—çˆ†è‚å·¥ä½œ (12hr/æ—¥)';
            }
        };
    },
    // é¡å¤–å·¥ä½œå¡ (ç”¨æ–¼ T1 éš¨æ©Ÿæ± )
    jobStableLow: () => {
        const basePay = 150;
        const pay = getDynamicPay(basePay);
        return {
            title: 'ğŸ›’ ä¾¿åˆ©å•†åº—åº—å“¡',
            tag: 'ä½è–ª',
            desc: `æ¨™æº–å·¥æ™‚ **8 å°æ™‚**ã€‚æ¯è¼ªæ”¶å…¥ $${pay}ã€‚`,
            effect: (p) => {
                p.stableJob = { name: 'ä¾¿åˆ©å•†åº—åº—å“¡', pay: pay, hours: 8, desc: '8hr/æ—¥' };
                return 'ç²å¾—ç©©å®šä½è–ªå·¥ä½œ (8hr/æ—¥)';
            }
        };
    },
    jobStableMed: () => {
        const basePay = 250;
        const pay = getDynamicPay(basePay);
        return {
            title: 'ğŸ‘¨â€ğŸ« è£œç¿’ç­è€å¸«',
            tag: 'ä¸­è–ª',
            desc: `æ¯æ—¥ **9 å°æ™‚**ã€‚æ¯è¼ªæ”¶å…¥ $${pay}ã€‚`,
            effect: (p) => {
                p.stableJob = { name: 'è£œç¿’ç­è€å¸«', pay: pay, hours: 9, desc: '9hr/æ—¥' };
                return 'ç²å¾—ä¸­ç­‰å·¥ä½œ (9hr/æ—¥)';
            }
        };
    },

    // å…¼è·é¡ (ç–ŠåŠ ï¼Œæœ‰è¼ªæ•¸)
    jobPartTime: () => {
        const hours = randInt(2, 4);
        const basePay = hours * randInt(20, 30); 
        const pay = getDynamicPay(basePay);
        const turns = randInt(3, 5);
        return {
            title: 'ğŸ›µ å¤–é€å…¼è·',
            tag: 'å…¼è·',
            desc: `æ¯æ—¥é¡å¤–å·¥ä½œ ${hours} å°æ™‚ï¼Œæ¯è¼ª +$${pay}ï¼ŒæŒçºŒ ${turns} è¼ªã€‚`,
            effect: (p) => {
                p.partTimeJobs.push({ name: 'å¤–é€', pay: pay, hours: hours, turnsLeft: turns });
                return `é–‹å§‹å…¼è· (æ¯æ—¥+${hours}hr, æŒçºŒ${turns}è¼ª)`;
            }
        };
    },
    
    // æ–°å¢ï¼šé¡å¤–æ”¶å…¥ (ä¸€æ¬¡æ€§)
    bonusCash: () => {
        const bonus = randInt(80, 150);
        return {
            title: 'ğŸ‰ è€é—†è³ç´…åŒ…',
            tag: 'é¡å¤–æ”¶å…¥',
            desc: `è€é—†å¿ƒæƒ…å¥½ï¼é¡å¤–ç²å¾— $${bonus} ç¾é‡‘ã€‚`,
            effect: (p) => {
                p.cash += bonus;
                return `ç²å¾—çé‡‘ $${bonus}`;
            }
        };
    },

    // éŠ€è¡Œé¡ï¼šå½ˆæ€§å­˜æ¬¾ (æ´»å­˜)
    depositFlexible: () => ({
        title: 'ğŸ’° å½ˆæ€§å­˜æ¬¾',
        tag: 'æ´»æœŸå­˜æ¬¾',
        desc: `é¸æ“‡å­˜å…¥ç¾é‡‘çš„ **20%, 50% æˆ– ALL**ã€‚ (é»æ“Šå¾Œè¼¸å…¥)`,
        effect: (p, amt) => {
            let amtToDeposit = Math.min(p.cash, amt);
            if (amtToDeposit <= 0) return 'æ²’ç¾é‡‘å¯å­˜';
            p.cash -= amtToDeposit;
            p.bank += amtToDeposit;
            log(`${p.name} é¸æ“‡å­˜å…¥ $${amtToDeposit} (ä½”æ¯” ${(amtToDeposit / (p.cash + amtToDeposit) * 100).toFixed(0)}%)`);
            return `å­˜å…¥ $${amtToDeposit}`;
        }
    }),
    
    // éŠ€è¡Œé¡ï¼šå®šå­˜ (é–å®š)
    depositFixed: () => {
        const cost = randInt(100, 300);
        const turns = randInt(4, 8); // é–å®š 4-8 è¼ª
        const fixedRate = randInt(5, 10) / 1000; // 0.5% - 1.0% per turn
        const totalReturnRate = 1 + fixedRate * turns; // ç¸½å ±é…¬ç‡
        
        return {
            title: 'ğŸ”’ å®šæœŸå­˜æ¬¾',
            tag: 'ç©©å®šç†è²¡',
            desc: `é–å®šç¾é‡‘ $${cost}ï¼Œ${turns} è¼ªå¾Œé ˜å›ã€‚ç¸½å ±é…¬ç‡ç´„ ${(fixedRate * turns * 100).toFixed(1)}%ã€‚`,
            effect: (p) => {
                if (p.cash < cost) return 'ç¾é‡‘ä¸è¶³ç„¡æ³•å®šå­˜';
                p.cash -= cost;
                p.lockedSavings.push({
                    cost: cost,
                    turnsLeft: turns,
                    totalReturnRate: totalReturnRate,
                    name: 'å®šå­˜'
                });
                return `é–å®š $${cost}ï¼Œ${turns} è¼ªå¾Œé ˜å›ã€‚`;
            }
        };
    },
    
    // éŠ€è¡Œé¡ï¼šæå–è³‡é‡‘
    withdraw: () => {
        const v = randInt(50, 100);
        return {
            title: 'ğŸ§ æå–è³‡é‡‘',
            tag: 'æ´»æœŸç†è²¡',
            desc: `é ˜å‡º $${v}ã€‚`,
            effect: (p) => {
                let amt = Math.min(p.bank, v);
                if (amt <= 0) return 'æ²’å­˜æ¬¾å¯é ˜';
                p.bank -= amt;
                p.cash += amt;
                return `é ˜å‡º $${amt}`;
            }
        };
    },
    
    // éŠ€è¡Œé¡ï¼šåˆ©ç‡è‡¨æ™‚æé«˜
    rateBoostLong: () => {
        const v = randInt(15, 40) / 1000; // 0.015 - 0.040 (1.5% - 4.0%)
        const turns = 3;
        return {
            title: 'ğŸ¦ éŠ€è¡ŒåŠ æ¯æ´»å‹•',
            tag: 'ç‰¹æ®Š',
            desc: `å­˜æ¬¾åˆ©ç‡åœ¨æ¥ä¸‹ä¾† ${turns} è¼ªè‡¨æ™‚ +${(v * 100).toFixed(1)}%ã€‚`,
            effect: (p) => {
                p.tempRateBoost.amount = v;
                p.tempRateBoost.turnsLeft = turns;
                return `åˆ©ç‡è‡¨æ™‚ +${(v * 100).toFixed(1)}% (${turns} è¼ª)`;
            }
        };
    },


    // æŠ•è³‡é¡ (é¢¨éšªåˆ¶)
    invest: () => {
        const risk = randInt(10, 100);
        let riskTag = 'risk-low';
        let riskText = 'ä¸­é«˜é¢¨éšª';
        if (risk > 50) { riskTag = 'risk-mid'; riskText = 'ä¸­é«˜é¢¨éšª'; }
        if (risk > 80) { riskTag = 'risk-high'; riskText = 'é«˜é¢¨éšª'; }

        const cost = randInt(50, 100);
        const maxRoi = 120 + Math.floor(risk * 1.5); 
        const wait = randInt(2, 4);

        return {
            title: 'ğŸš€ çŸ­æœŸæŠ•è³‡æ©Ÿæœƒ',
            tag: riskText,
            riskLevel: riskTag, 
            desc: `æŠ•å…¥ $${cost}ï¼Œ${wait} è¼ªå¾Œçµç®—ã€‚é¢¨éšªå€¼: ${risk}ã€‚`,
            effect: (p) => {
                if (p.cash < cost) return 'ç¾é‡‘ä¸è¶³ç„¡æ³•æŠ•è³‡';
                p.cash -= cost;
                p.investments.push({
                    cost: cost,
                    maxRoi: maxRoi,
                    risk: risk,
                    turnsLeft: wait
                });
                return `æŠ•å…¥è³‡é‡‘ $${cost}`;
            }
        };
    },
    
    // æ–°å¢ï¼šè‚¡ç¥¨æŠ•è³‡ (é•·æœŸ)
    investStock: () => {
        const cost = randInt(300, 500); // è‚¡ç¥¨è³¼å…¥æˆæœ¬è¼ƒé«˜
        return {
            title: 'ğŸ¦ è—ç±Œè‚¡æŠ•è³‡',
            tag: 'é•·æœŸç©©å®š',
            desc: `æŠ•å…¥ $${cost} è²·å…¥è—ç±Œè‚¡ï¼Œæ¯è¼ªæ”¶å– $8-$15 è‚¡åˆ©ã€‚`,
            effect: (p) => {
                if (p.cash < cost) return 'ç¾é‡‘ä¸è¶³ç„¡æ³•è³¼è²·è‚¡ç¥¨';
                // æª¢æŸ¥æ˜¯å¦å·²æŒæœ‰è—ç±Œè‚¡ (é˜²æ­¢é‡è¤‡æŠ•å…¥ï¼Œä½†å…è¨±é‡è¤‡é¸å–)
                let existingStock = p.stocks.find(s => s.name === 'è—ç±Œè‚¡');
                if (existingStock) {
                    existingStock.cost += cost;
                    p.cash -= cost;
                    return `å†æ¬¡æŠ•å…¥ $${cost} è³¼è²·è—ç±Œè‚¡`;
                } else {
                    p.cash -= cost;
                    p.stocks.push({ name: 'è—ç±Œè‚¡', cost: cost });
                    return `æŠ•å…¥ $${cost} è³¼è²·è—ç±Œè‚¡`;
                }
            }
        };
    },

    
    // ä¼‘æ¯ (æ¢å¾©å¥åº·)
    rest: () => ({
        title: 'ğŸ§˜ æ·±åº¦ä¼‘æ¯',
        tag: 'å¥åº·',
        desc: 'èŠ±è²» $20 é€²è¡Œèª¿é¤Šï¼Œæ¢å¾© 15 é»å¥åº·å€¼ã€‚',
        effect: (p) => {
            if (p.cash < 20) return 'æ²’éŒ¢ä¼‘æ¯';
            p.cash -= 20;
            let heal = 15;
            p.hp = Math.min(CONFIG.maxHp, p.hp + heal);
            return `å¥åº·æ¢å¾© +${heal}`;
        }
    })
};

function generateCards(playerIdx) {
    let pool = [];

    // T1: å›ºå®šç‚ºå·¥ä½œé¸æ“‡
    if (gameState.turn === 1) {
        // T1 åŒ…å«æ‰€æœ‰ 5 ç¨®ç©©å®šå·¥ä½œé¡å‹
        const t1Jobs = [
            generators.jobStableStandard,
            generators.jobStableShift,
            generators.jobStableOvertime,
            generators.jobStableLow,
            generators.jobStableMed
        ];
        
        let uniqueT1Deck = [];
        
        // ä½¿ç”¨Fisher-Yatesæ´—ç‰Œæ³•ç¢ºä¿éš¨æ©Ÿé †åºï¼Œä¸¦å–å‰5å€‹
        for (let i = t1Jobs.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [t1Jobs[i], t1Jobs[j]] = [t1Jobs[j], t1Jobs[i]];
        }

        uniqueT1Deck = t1Jobs.map(genFunc => genFunc());

        gameState.currentCards = uniqueT1Deck;
        
    } else {
        // T2 ä¹‹å¾Œï¼šèª¿æ•´æ©Ÿç‡çš„æ··åˆç‰Œåº«
        pool = [
            // å·¥ä½œæ©Ÿæœƒ (2 ä»½) - ä½æ©Ÿç‡
            generators.jobStableStandard, generators.jobStableShift,
            
            // å…¼è· (3 ä»½)
            generators.jobPartTime, generators.jobPartTime, generators.jobPartTime,
            
            // é¡å¤–æ”¶å…¥ (2 ä»½) - æ–°å¢
            generators.bonusCash, generators.bonusCash,

            // éŠ€è¡Œç†è²¡ (4 ä»½ - æ´»å­˜/é ˜å‡º/åŠ æ¯/å®šå­˜)
            generators.depositFlexible, generators.withdraw, generators.rateBoostLong, generators.depositFixed,
            
            // æŠ•è³‡ (4 ä»½ - çŸ­æœŸé¢¨éšªæŠ•è³‡)
            generators.invest, generators.invest, generators.invest, generators.invest,
            
            // è‚¡ç¥¨æŠ•è³‡ (1 ä»½) - æ–°å¢
            generators.investStock,
            
            // å¥åº·ä¼‘æ¯ (2 ä»½)
            generators.rest, generators.rest
        ]; // Total: 2 + 3 + 2 + 4 + 4 + 1 + 2 = 18

        // T2+ ç¢ºä¿æŠ½ 5 å¼µä¸é‡è¤‡
        let uniqueDeck = [];
        let cardTitles = new Set();
        const maxAttempts = pool.length * 2; 
        let attempts = 0;

        while(uniqueDeck.length < 5 && attempts < maxAttempts) {
            let genFunc = pool[Math.floor(Math.random() * pool.length)];
            let card = genFunc();
            if (!cardTitles.has(card.title)) {
                cardTitles.add(card.title);
                uniqueDeck.push(card);
            }
            attempts++;
        }
        gameState.currentCards = uniqueDeck;
    }
    
    renderCards();
}

function renderCards() {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';
    
    gameState.currentCards.forEach((card, idx) => {
        let div = document.createElement('div');
        div.className = `card`; 
        div.id = `card-${idx}`; 
        
        let tagClass = 'tag-none';
        if (card.tag.includes('é¢¨éšª')) tagClass = `tag-${card.riskLevel}`;
        else if (card.tag.includes('å·¥ä½œ') || card.tag.includes('å…¼è·')) tagClass = 'tag-job';
        else if (card.tag.includes('å¥åº·') || card.tag.includes('ç‰¹æ®Š') || card.tag.includes('ç†è²¡') || card.tag.includes('æ”¶å…¥') || card.tag.includes('ç©©å®š')) tagClass = 'tag-special';

        // å­˜æ¬¾å¡ç‰‡ç‰¹æ®Šæ¨™è¨»
        let clickText = (card.title === 'ğŸ’° å½ˆæ€§å­˜æ¬¾') ? 'é»æ“Šè¼¸å…¥æ¯”ä¾‹ (ç«‹å³åŸ·è¡Œ)' : 'é»æ“Šé¸æ“‡';
        
        // ç¢ºä¿å®šå­˜å’Œæ´»å­˜æœ‰ç‰¹æ®Šæ¨™ç±¤
        if (card.title === 'ğŸ’° å½ˆæ€§å­˜æ¬¾' || card.title === 'ğŸ”’ å®šæœŸå­˜æ¬¾' || card.title === 'ğŸ§ æå–è³‡é‡‘' || card.title === 'ğŸ¦ è—ç±Œè‚¡æŠ•è³‡') tagClass = 'tag-special';


        div.innerHTML = `
            <div>
                <div class="card-header">
                    <div class="card-title">${card.title}</div>
                    <span class="tag ${tagClass}">${card.tag}</span>
                </div>
                <div class="card-desc">${card.desc}</div>
            </div>
            <small style="color:#7f8c8d; font-size:0.9em;">${clickText}</small>
        `;
        div.onclick = () => handleCardClick(idx);
        container.appendChild(div);
    });
}

// --- çµç®—æ ¸å¿ƒ (åŒ…å«æ”¶å…¥æ—¥èªŒ) ---
function processTurn() {
    log(`--- ç¬¬ ${gameState.turn} è¼ªçµç®— ---`, 'turn');
    
    handleGlobalEvents();

    gameState.players.forEach(p => {
        let logs = [];
        p.roundIncome = 0;
        let jobIncome = 0; 
        
        // --- 1. è¨ˆç®—å·¥æ™‚èˆ‡å¥åº· ---
        let dailyHours = 0;
        if (p.stableJob) dailyHours += p.stableJob.hours;
        p.partTimeJobs.forEach(j => dailyHours += j.hours);
        
        if (dailyHours > CONFIG.safeHours) {
            let over = dailyHours - CONFIG.safeHours;
            let dmg = over * CONFIG.overworkPenalty;
            p.hp -= dmg;
            logs.push(`<span class="log-bad">éå‹(${dailyHours}hr) å¥åº· -${dmg.toFixed(1)}</span>`);
        }

        // --- 2. ç”Ÿç—…åˆ¤å®š ---
        let sickChance = (100 - p.hp) * 0.5 / 100;
        if (Math.random() < sickChance) {
            let cost = 100;
            p.cash -= cost;
            p.hp = Math.min(CONFIG.maxHp, p.hp + 5);
            logs.push(`<span class="log-bad">ğŸ¤’ é«”åŠ›ä¸æ”¯é€é†« -$${cost} (å¥åº·+5)</span>`);
        }

        // --- 3. æ”¶å…¥çµç®— (å·¥ä½œ/å…¼è·) ---
        if (p.stableJob) {
            p.roundIncome += p.stableJob.pay;
            p.cash += p.stableJob.pay;
            jobIncome += p.stableJob.pay;
        }
        
        // å…¼è·
        p.partTimeJobs.forEach(j => {
            p.roundIncome += j.pay;
            p.cash += j.pay;
            jobIncome += j.pay;
            j.turnsLeft--;
        });
        p.partTimeJobs = p.partTimeJobs.filter(j => j.turnsLeft > 0);
        
        if (jobIncome > 0) {
             logs.push(`<span class="log-good">å·¥ä½œæ”¶å…¥ +$${jobIncome}</span>`);
        }
        
        // --- 4. è‚¡ç¥¨è‚¡åˆ©æ”¶å…¥ (æ–°å¢) ---
        let dividendIncome = 0;
        p.stocks.forEach(s => {
            // æ¯ $100 æˆæœ¬æä¾› $2 - $5 è‚¡åˆ©
            let baseDiv = Math.floor(s.cost / 100);
            let dividend = randInt(8, 15) + baseDiv; 
            p.cash += dividend;
            p.roundIncome += dividend;
            dividendIncome += dividend;
        });
        if (dividendIncome > 0) {
             logs.push(`<span class="log-good">ğŸ’¸ è‚¡åˆ©æ”¶å…¥ +$${dividendIncome}</span>`);
        }

        // --- 5. æŠ•è³‡çµç®— (çŸ­æœŸé¢¨éšª) ---
        p.investments = p.investments.filter(inv => {
            inv.turnsLeft--;
            if (inv.turnsLeft === 0) {
                let roll = Math.random() * 100; 
                let volatility = inv.risk * 1.5; 
                
                if (roll < (inv.risk / 2.5)) {
                    // è™§æäº‹ä»¶
                    let lossRate = randInt(10, 50 + inv.risk/2); 
                    if (inv.risk > 80 && Math.random() < 0.2) lossRate = 150; // çˆ†å€‰è² å‚µ
                    
                    let returnVal = Math.floor(inv.cost * (100 - lossRate) / 100);
                    let netLoss = inv.cost - returnVal; 
                    p.cash += returnVal; 
                    logs.push(`<span class="log-bad">æŠ•è³‡å¤±åˆ©(R:${inv.risk}) è™§æ $${netLoss}</span>`);
                } else {
                    // ç²åˆ©
                    let profitRate = randInt(10, inv.maxRoi - 100);
                    let totalBack = Math.floor(inv.cost * (100 + profitRate) / 100);
                    let netProfit = totalBack - inv.cost;
                    p.cash += totalBack;
                    logs.push(`<span class="log-good">æŠ•è³‡ç²åˆ©(R:${inv.risk}) +$${netProfit}</span>`);
                    p.roundIncome += netProfit;
                }
                return false; 
            }
            return true; 
        });
        
        // --- 6. å®šå­˜çµç®— ---
        p.lockedSavings = p.lockedSavings.filter(locked => {
            locked.turnsLeft--;
            if (locked.turnsLeft === 0) {
                let returnAmt = Math.floor(locked.cost * locked.totalReturnRate);
                let netProfit = returnAmt - locked.cost;
                p.cash += returnAmt;
                logs.push(`<span class="log-good">å®šå­˜åˆ°æœŸ +$${returnAmt} (æ·¨åˆ©+$${netProfit})</span>`);
                p.roundIncome += netProfit; // å®šå­˜æ·¨åˆ©ä¹Ÿç®—å…¥æœ¬è¼ªæ”¶å…¥
                return false; 
            }
            return true; 
        });


        // --- 7. å¼·åˆ¶æ”¯å‡º (ç”Ÿæ´»è²» + åä¸€) ---
        p.cash -= CONFIG.livingCost;
        logs.push(`ç”Ÿæ´»è²» -$${CONFIG.livingCost}`);

        if (p.roundIncome > 0) {
            let tithe = Math.floor(p.roundIncome * CONFIG.titheRate);
            p.cash -= tithe;
            logs.push(`åä¸€å¥‰ç» -$${tithe}`);
        }

        // --- 8. åˆ©æ¯ (æ´»å­˜) ---
        let currentRate = p.rate; 
        
        if (p.tempRateBoost.turnsLeft > 0) {
            currentRate += p.tempRateBoost.amount;
            p.tempRateBoost.turnsLeft--; 
        }

        let interest = Math.floor(p.bank * currentRate);
        if (interest > 0) {
            p.bank += interest;
            logs.push(`æ´»å­˜åˆ©æ¯(${(currentRate*100).toFixed(1)}%) <span class="log-good">+$${interest}</span>`);
            p.roundIncome += interest;
        }
        
        // --- 9. ç ´ç”¢è™•ç† ---
        if (p.cash < 0) {
            if (p.bank >= -p.cash) {
                p.bank += p.cash; 
                p.cash = 0;
                logs.push(`è‡ªå‹•è½‰å¸³è£œèµ¤å­—`);
            } else {
                p.cash += p.bank;
                p.bank = 0;
                logs.push(`<span class="log-bad">ç¾é‡‘ä¸è¶³ç”¢ç”Ÿè² å‚µ $${-p.cash}</span>`);
            }
        }
        
        // é™åˆ¶ HP ç¯„åœ
        if (p.hp < 0) p.hp = 0;

        if (logs.length) log(`${p.name}: ${logs.join(' | ')}`);
    });

    gameState.turn++;
    if (gameState.turn > CONFIG.maxTurns) {
        endGame();
    } else {
        startPlayerTurn(0);
    }
}

function handleGlobalEvents() {
    if (gameState.turn > 5 && Math.random() < 0.4) {
        const bills = [
            { t: 'ğŸ’¸ æ”¶åˆ°ç‡ƒæ–™ç¨…å–®', amt: 30 },
            { t: 'âš¡ å¤å­£é›»è²»å¸³å–®', amt: 25 },
            { t: 'ğŸš— æ©Ÿè»Šå¼·åˆ¶éšªçºŒä¿', amt: 15 },
            { t: 'ğŸ“± æ‰‹æ©Ÿè¢å¹•æ‘”å£', amt: 40 }
        ];
        let bill = bills[randInt(0, bills.length-1)];
        log(`[å¸³å–®] ${bill.t} -$${bill.amt}`, 'event');
        gameState.players.forEach(p => p.cash -= bill.amt);
    }
}

// --- è¼”åŠ©å‡½å¼ ---
function updateUI() {
    document.getElementById('turn-display').innerText = `ç¬¬ ${gameState.turn} / ${CONFIG.maxTurns} è¼ª`;
    
    const phases = {
        'p1_choice': 'A çµ„è¡Œå‹• (é¸ 1-' + gameState.maxSelections + ' å¼µ)',
        'p2_choice': 'B çµ„è¡Œå‹• (é¸ 1-' + gameState.maxSelections + ' å¼µ)',
        'processing': 'çµç®—ä¸­...'
    };
    document.getElementById('phase-msg').innerText = phases[gameState.phase];

    updatePlayerUI(0, 'p1');
    updatePlayerUI(1, 'p2');

    document.getElementById('p1-stats').classList.toggle('active', gameState.phase === 'p1_choice');
    document.getElementById('p2-stats').classList.toggle('active', gameState.phase === 'p2_choice');
}

function updatePlayerUI(idx, prefix) {
    let p = gameState.players[idx];
    
    // é‡‘éŒ¢
    let cashEl = document.getElementById(`${prefix}-cash`);
    cashEl.innerText = `$${p.cash}`;
    cashEl.className = p.cash < 0 ? 'money debt' : 'money';
    document.getElementById(`${prefix}-bank`).innerText = `$${p.bank}`;
    
    // å¥åº·
    document.getElementById(`${prefix}-hp-text`).innerText = Math.floor(p.hp);
    let hpBar = document.getElementById(`${prefix}-hp-bar`);
    hpBar.style.width = `${Math.max(0, p.hp)}%`;
    if (p.hp < 30) hpBar.style.background = '#e74c3c';
    else if (p.hp < 70) hpBar.style.background = '#f39c12';
    else hpBar.style.background = '#27ae60';

    // åˆ©ç‡
    let finalRate = (p.rate + p.tempRateBoost.amount) * 100;
    let rateText = `${finalRate.toFixed(1)}%`;
    if (p.tempRateBoost.turnsLeft > 0) {
        rateText += ` (+${p.tempRateBoost.turnsLeft} è¼ª)`;
    }
    document.getElementById(`${prefix}-rate`).innerText = rateText;

    // ç‹€æ…‹æè¿°
    let statusParts = [];
    if (p.stableJob) {
        statusParts.push(`æ­£è·: ${p.stableJob.name} (${p.stableJob.hours}hr/æ—¥)`);
    }
    else statusParts.push("å¾…æ¥­ä¸­");
    
    if (p.partTimeJobs.length > 0) statusParts.push(`å…¼è·x${p.partTimeJobs.length} (${p.partTimeJobs.reduce((sum, j) => sum + j.hours, 0)}hr)`);
    if (p.investments.length > 0) statusParts.push(`çŸ­æœŸæŠ•è³‡x${p.investments.length}`);
    if (p.lockedSavings.length > 0) statusParts.push(`å®šå­˜x${p.lockedSavings.length}`); 
    if (p.stocks.length > 0) statusParts.push(`è‚¡ç¥¨x${p.stocks.length}`); // é¡¯ç¤ºè‚¡ç¥¨æŒæœ‰
    
    document.getElementById(`${prefix}-status`).innerText = statusParts.join(' | ');
}

function endGame() {
    let p1Total = gameState.players[0].cash + gameState.players[0].bank + getAssets(gameState.players[0]);
    let p2Total = gameState.players[1].cash + gameState.players[1].bank + getAssets(gameState.players[1]);
    
    let winner = p1Total > p2Total ? "ğŸ† A çµ„ç²å‹ï¼" : (p2Total > p1Total ? "ğŸ† B çµ„ç²å‹ï¼" : "ğŸ¤ å¹³æ‰‹ï¼");

    let html = `
        <div style="text-align:center; background:white; padding:30px; border-radius:10px;">
            <h1 style="color:#e67e22; font-size: 2.5em;">${winner}</h1>
            <div style="display:flex; justify-content:space-around; margin:30px 0;">
                <div style="font-size: 1.2em;">
                    <h3>A çµ„ç¸½è³‡ç”¢</h3>
                    <div style="font-size:2.5em; color:#27ae60">$${p1Total}</div>
                    <small>å¥åº·: ${Math.floor(gameState.players[0].hp)}</small>
                </div>
                <div style="font-size: 1.2em;">
                    <h3>B çµ„ç¸½è³‡ç”¢</h3>
                    <div style="font-size:2.5em; color:#27ae60">$${p2Total}</div>
                    <small>å¥åº·: ${Math.floor(gameState.players[1].hp)}</small>
                </div>
            </div>
            <button class="confirm-btn" onclick="location.reload()">å†ä¾†ä¸€å±€</button>
        </div>
    `;
    document.getElementById('cards-container').innerHTML = html;
}

function getAssets(p) {
    let val = 0;
    // ä¼°ç®—çŸ­æœŸæŠ•è³‡åƒ¹å€¼ (æŠ•å…¥æˆæœ¬çš„ 50%)
    p.investments.forEach(i => val += Math.floor(i.cost * 0.5)); 
    // å®šå­˜åƒ¹å€¼ (å·²æŠ•å…¥æˆæœ¬)
    p.lockedSavings.forEach(i => val += i.cost); 
    // è‚¡ç¥¨åƒ¹å€¼ (æŠ•å…¥æˆæœ¬)
    p.stocks.forEach(i => val += i.cost); 
    return val;
}

function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function log(msg, type='') {
    const area = document.getElementById('game-log');
    const div = document.createElement('div');
    div.className = 'log-entry';
    if (type === 'turn') div.innerHTML = `<span class="log-turn">${msg}</span>`;
    else if (type === 'bad') div.innerHTML = `<span class="log-bad">${msg}</span>`;
    else div.innerHTML = msg;
    area.prepend(div);
}
</script>
</body>
</html>
