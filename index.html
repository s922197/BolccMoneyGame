<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾ç•œç”Ÿå­˜æˆ°ï¼šç†è²¡ Roguelike v2.0</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --bg: #ecf0f1;
            --card-bg: #fff;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
        }
        .container {
            max-width: 1000px;
            width: 100%;
        }
        
        /* å„€è¡¨æ¿ */
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .player-stats {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex: 1 1 300px;
            border-top: 5px solid #bdc3c7;
            transition: all 0.3s;
            position: relative;
        }
        .player-stats.active {
            border-top-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }
        
        /* æ•¸å€¼é¡¯ç¤º */
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 1em;
            align-items: center;
        }
        .money { color: var(--accent); font-weight: bold; font-family: monospace; font-size: 1.1em; }
        .debt { color: var(--danger); font-weight: bold; }
        
        /* å¥åº·æ¢ */
        .hp-bar-bg {
            width: 100px;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .hp-bar-fill {
            height: 100%;
            transition: width 0.5s, background 0.5s;
        }

        /* éŠæˆ²è³‡è¨Šèˆ‡éšæ®µ */
        .phase-indicator {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #d35400;
            margin: 10px 0;
            background: #fad7a0;
            padding: 5px;
            border-radius: 5px;
        }

        /* å¡ç‰Œå€åŸŸ */
        .cards-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .card {
            background: var(--card-bg);
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px;
            position: relative;
        }
        .card:hover { transform: translateY(-3px); border-color: #bdc3c7; }
        .card.selected {
            border-color: var(--accent);
            background-color: #e8f8f5;
            box-shadow: 0 0 0 2px var(--accent);
        }
        .card.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .card-title { font-weight: bold; color: #2980b9; font-size: 1em; line-height: 1.2; }
        .card-desc { font-size: 0.85em; color: #555; line-height: 1.4; flex-grow: 1; }
        
        /* æ¨™ç±¤ */
        .tag {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
        .tag-job { background: #3498db; }
        .tag-risk-low { background: #27ae60; }
        .tag-risk-mid { background: #f39c12; }
        .tag-risk-high { background: #c0392b; }
        .tag-none { background: #95a5a6; }

        /* ç¢ºèªæŒ‰éˆ• */
        .action-area {
            text-align: center;
            margin: 20px 0;
            height: 50px;
        }
        .confirm-btn {
            padding: 12px 40px;
            font-size: 1.2em;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 0 #1e8449;
            transition: transform 0.1s;
        }
        .confirm-btn:active { transform: translateY(4px); box-shadow: none; }
        .confirm-btn:disabled { background: #95a5a6; box-shadow: none; cursor: not-allowed; }

        /* æ—¥èªŒ */
        .log-area {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px dashed #eee; }
        .log-turn { color: #fff; background: #e67e22; padding: 2px 5px; border-radius: 3px; }
        .log-bad { color: #c0392b; }
        .log-good { color: #27ae60; }

        /* ç‹€æ…‹æ–‡å­—å°å­— */
        .status-text { font-size: 0.8em; color: #7f8c8d; margin-top: 5px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen" style="text-align: center; margin-top: 50px;">
        <h1>ğŸ¥ ç¤¾ç•œç”Ÿå­˜æˆ° Roguelike</h1>
        <h3>ç†è²¡ x å¥åº· x éš¨æ©Ÿäº‹ä»¶</h3>
        <div style="background: white; padding: 20px; border-radius: 10px; display: inline-block; text-align: left;">
            <p>âœ… <b>ç›®æ¨™ï¼š</b>20 è¼ªå¾Œç¸½è³‡ç”¢æœ€é«˜è€…ç²å‹</p>
            <p>âœ… <b>è¦å‰‡ï¼š</b>æ¯è¼ªå¾ 5 å€‹é¸é …ä¸­<b>é¸æ“‡ 2 å€‹</b>åŸ·è¡Œ</p>
            <p>â¤ï¸ <b>å¥åº·ï¼š</b>å·¥æ™‚éé•·(>8hr)æœƒæ‰£å¥åº·ï¼Œå¥åº·ä½å®¹æ˜“ç”Ÿç—…ç ´è²¡</p>
            <p>ğŸ’¼ <b>å·¥ä½œï¼š</b>ç©©å®šå·¥ä½œåªèƒ½ä¸€ä»½ï¼Œå¯éš¨æ™‚è¢«æ–°å·¥ä½œæ›¿æ›</p>
        </div>
        <br><br>
        <button class="confirm-btn" onclick="startGame()">é–‹å§‹å°æŠ—</button>
    </div>

    <div id="game-screen" style="display: none;">
        <div class="phase-indicator">
            <span id="turn-display">æº–å‚™ä¸­...</span> | <span id="phase-msg"></span>
        </div>

        <div class="dashboard">
            <div class="player-stats" id="p1-stats">
                <h3>ğŸ‘¨â€ğŸ’¼ A çµ„ <span style="font-size:0.6em; color:#7f8c8d">(ç©å®¶ 1)</span></h3>
                <div class="stat-row">
                    <span>ç¾é‡‘/å­˜æ¬¾</span>
                    <span><span class="money" id="p1-cash">$100</span> / <span class="money" id="p1-bank">$0</span></span>
                </div>
                <div class="stat-row">
                    <span>å¥åº·å€¼</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span id="p1-hp-text">100</span>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" id="p1-hp-bar" style="width:100%; background:#27ae60;"></div></div>
                    </div>
                </div>
                <div class="stat-row">åˆ©ç‡: <span class="money" style="color:#8e44ad" id="p1-rate">1.0%</span></div>
                <div class="status-text" id="p1-status">ç„¡å·¥ä½œ</div>
            </div>

            <div class="player-stats" id="p2-stats">
                <h3>ğŸ‘©â€ğŸ’» B çµ„ <span style="font-size:0.6em; color:#7f8c8d">(ç©å®¶ 2)</span></h3>
                <div class="stat-row">
                    <span>ç¾é‡‘/å­˜æ¬¾</span>
                    <span><span class="money" id="p2-cash">$100</span> / <span class="money" id="p2-bank">$0</span></span>
                </div>
                <div class="stat-row">
                    <span>å¥åº·å€¼</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span id="p2-hp-text">100</span>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" id="p2-hp-bar" style="width:100%; background:#27ae60;"></div></div>
                    </div>
                </div>
                <div class="stat-row">åˆ©ç‡: <span class="money" style="color:#8e44ad" id="p2-rate">1.0%</span></div>
                <div class="status-text" id="p2-status">ç„¡å·¥ä½œ</div>
            </div>
        </div>

        <div id="cards-container" class="cards-area"></div>

        <div class="action-area">
            <button id="confirm-btn" class="confirm-btn" onclick="confirmSelection()" disabled>ç¢ºèªé¸æ“‡ (0/2)</button>
        </div>

        <h3>ğŸ“ äº‹ä»¶æ—¥èªŒ</h3>
        <div class="log-area" id="game-log"></div>
    </div>
</div>

<script>
const CONFIG = {
    maxTurns: 20,
    startCash: 100,
    livingCost: 10,
    titheRate: 0.1,
    baseRate: 0.01,
    startHp: 100,
    maxHp: 100,
    safeHours: 8, // æ¯æ—¥å®‰å…¨å·¥æ™‚
    overworkPenalty: 3 // æ¯è¶…æ™‚1å°æ™‚æ‰£é™¤çš„å¥åº·å€¼
};

let gameState = {
    turn: 1,
    phase: 'p1_choice', 
    players: [],
    currentCards: [],
    selectedCardIndices: []
};

// --- åˆå§‹åŒ– ---
function createPlayer(name) {
    return {
        name: name,
        cash: CONFIG.startCash,
        bank: 0,
        rate: CONFIG.baseRate,
        tempRateBoost: 0,
        hp: CONFIG.startHp,
        stableJob: null, // { name, pay, hours, type }
        partTimeJobs: [], // { name, pay, hours, turnsLeft }
        investments: [],
        lockedSavings: [],
        roundIncome: 0
    };
}

function startGame() {
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    
    gameState.turn = 1;
    gameState.players = [createPlayer('A çµ„'), createPlayer('B çµ„')];
    
    log("=== éŠæˆ²é–‹å§‹ ===", 'turn');
    log("ç›®æ¨™ï¼šæ´»ä¸‹å»ä¸¦è‡´å¯Œã€‚æ¯æ—¥å·¥æ™‚è¶…é 8 å°æ™‚å°‡æå®³å¥åº·ï¼");
    
    startPlayerTurn(0);
}

// --- éŠæˆ²æµç¨‹æ§åˆ¶ ---
function startPlayerTurn(playerIdx) {
    gameState.phase = playerIdx === 0 ? 'p1_choice' : 'p2_choice';
    gameState.selectedCardIndices = [];
    updateUI();
    generateCards(playerIdx);
    updateConfirmButton();
}

function handleCardClick(index) {
    const selected = gameState.selectedCardIndices;
    const pos = selected.indexOf(index);

    if (pos >= 0) {
        // å–æ¶ˆé¸å–
        selected.splice(pos, 1);
    } else {
        // é¸å– (æœ€å¤š2å€‹)
        if (selected.length < 2) {
            selected.push(index);
        }
    }
    
    renderCards(); // é‡ç¹ªé¸å–ç‹€æ…‹
    updateConfirmButton();
}

function updateConfirmButton() {
    const btn = document.getElementById('confirm-btn');
    const count = gameState.selectedCardIndices.length;
    btn.innerText = `ç¢ºèªåŸ·è¡Œ (${count}/2)`;
    btn.disabled = count !== 2;
}

function confirmSelection() {
    const playerIdx = gameState.phase === 'p1_choice' ? 0 : 1;
    const player = gameState.players[playerIdx];
    
    // ä¾åºåŸ·è¡Œå…©å¼µå¡ç‰‡
    // æ³¨æ„ï¼šæŒ‰é †åºåŸ·è¡Œï¼Œæœ‰å¯èƒ½ç¬¬ä¸€å¼µå°è‡´ç¬¬äºŒå¼µæ¢ä»¶ä¸ç¬¦(å¦‚ç¾é‡‘ä¸è¶³)ï¼Œéœ€åœ¨ effect ä¸­è™•ç†
    gameState.selectedCardIndices.forEach(idx => {
        const card = gameState.currentCards[idx];
        const result = card.effect(player);
        log(`${player.name} åŸ·è¡Œ [${card.title}]: ${result}`);
    });

    if (playerIdx === 0) {
        startPlayerTurn(1);
    } else {
        gameState.phase = 'processing';
        updateUI();
        document.getElementById('cards-container').innerHTML = '<h3 style="text-align:center;width:100%;color:#aaa;">çµç®—ä¸­...</h3>';
        setTimeout(processTurn, 800);
    }
}

// --- å¡ç‰Œç”Ÿæˆå™¨ ---
const generators = {
    // ç©©å®šå·¥ä½œé¡ (æ›¿æ›åˆ¶)
    jobStableStandard: () => ({
        type: 'JOB_STABLE',
        title: 'ğŸ’¼ ä¸€èˆ¬è·å“¡',
        tag: 'ç©©å®šå·¥ä½œ',
        desc: 'æ¨™æº–å·¥æ™‚ï¼Œé€±ä¼‘äºŒæ—¥ã€‚æ™‚è–ªæ™®é€šä½†ç©©å®šã€‚',
        val: { pay: 200, hours: 8 }, // æ¯å¤©8å°æ™‚
        effect: (p) => {
            p.stableJob = { name: 'ä¸€èˆ¬è·å“¡', pay: 200, hours: 8, desc: '8hr/æ—¥' };
            return 'ç²å¾—ç©©å®šå·¥ä½œ (8hr/æ—¥)';
        }
    }),
    jobStableShift: () => ({
        type: 'JOB_STABLE',
        title: 'ğŸ­ ç”¢ç·šä½œæ¥­å“¡',
        tag: 'åšäºŒä¼‘äºŒ',
        desc: 'æ¯æ—¥ 12 å°æ™‚ï¼ŒåšäºŒä¼‘äºŒ(å¹³å‡å·¥æ™‚è¼ƒä½ï¼Œä½†å·¥ä½œæ—¥æ¥µç´¯)ã€‚',
        // ç‚ºäº†ç°¡åŒ–ï¼Œè¨­å¹³å‡æ—¥å·¥æ™‚é«˜æ–¼8ä¸€é»é»ï¼Œæˆ–è€…ç›´æ¥è¨­é«˜å·¥æ™‚é«˜è–ªæ°´
        // é€™è£¡è¨­å®šï¼šæ¯å¤©ç®— 10 å°æ™‚å·¥æ™‚ (æŠ˜è¡·)ï¼Œè–ªæ°´é«˜
        val: { pay: 300, hours: 10 }, 
        effect: (p) => {
            p.stableJob = { name: 'ä½œæ¥­å“¡(åšäºŒä¼‘äºŒ)', pay: 300, hours: 10, desc: '10hr/æ—¥(å‡)' };
            return 'ç²å¾—é«˜å·¥æ™‚å·¥ä½œ (10hr/æ—¥)';
        }
    }),
    jobStableOvertime: () => ({
        type: 'JOB_STABLE',
        title: 'ğŸ’» è²¬ä»»åˆ¶å·¥ç¨‹å¸«',
        tag: 'çˆ†è‚',
        desc: 'é«˜è–ªï¼Œä½†æ¯å¤©å¹³å‡å·¥ä½œ 12 å°æ™‚ã€‚',
        val: { pay: 450, hours: 12 },
        effect: (p) => {
            p.stableJob = { name: 'è²¬ä»»åˆ¶å·¥ç¨‹å¸«', pay: 450, hours: 12, desc: '12hr/æ—¥' };
            return 'ç²å¾—çˆ†è‚å·¥ä½œ (12hr/æ—¥)';
        }
    }),

    // å…¼è·é¡ (ç–ŠåŠ ï¼Œæœ‰è¼ªæ•¸)
    jobPartTime: () => {
        const hours = randInt(2, 4);
        const pay = hours * randInt(20, 30); // æ™‚è–ªç´„ 20-30
        const turns = randInt(3, 5);
        return {
            type: 'JOB_PART',
            title: 'ğŸ›µ å¤–é€å…¼è·',
            tag: 'å…¼è·',
            desc: `æ¯æ—¥é¡å¤–å·¥ä½œ ${hours} å°æ™‚ï¼Œæ¯è¼ª +$${pay}ï¼ŒæŒçºŒ ${turns} è¼ªã€‚`,
            effect: (p) => {
                p.partTimeJobs.push({ name: 'å¤–é€', pay: pay, hours: hours, turnsLeft: turns });
                return `é–‹å§‹å…¼è· (æ¯æ—¥+${hours}hr)`;
            }
        };
    },

    // éŠ€è¡Œé¡
    deposit: () => {
        const v = randInt(50, 150); // æé«˜å­˜æ¬¾é‡
        return {
            title: 'ğŸ’° å­˜å…¥è³‡é‡‘',
            tag: 'ç†è²¡',
            desc: `å­˜å…¥ $${v} (ç¾é‡‘ä¸è¶³å‰‡å…¨å­˜)ã€‚`,
            effect: (p) => {
                let amt = Math.min(p.cash, v);
                if (amt <= 0) return 'æ²’ç¾é‡‘å¯å­˜';
                p.cash -= amt;
                p.bank += amt;
                return `å­˜å…¥ $${amt}`;
            }
        };
    },
    withdraw: () => {
        const v = randInt(50, 100);
        return {
            title: 'ğŸ§ æå–è³‡é‡‘',
            tag: 'ç†è²¡',
            desc: `é ˜å‡º $${v}ã€‚`,
            effect: (p) => {
                let amt = Math.min(p.bank, v);
                if (amt <= 0) return 'æ²’å­˜æ¬¾å¯é ˜';
                p.bank -= amt;
                p.cash += amt;
                return `é ˜å‡º $${amt}`;
            }
        };
    },
    rateBoost: () => {
        const v = randInt(15, 40) / 10; // 1.5% - 4.0%
        return {
            title: 'ğŸ“ˆ åˆ©ç‡åŠ ç¢¼',
            tag: 'éŠ€è¡Œæ´»å‹•',
            desc: `æœ¬è¼ªå­˜æ¬¾åˆ©ç‡è‡¨æ™‚ +${v}%ã€‚`,
            effect: (p) => {
                p.tempRateBoost += (v / 100);
                return `åˆ©ç‡è‡¨æ™‚ +${v}%`;
            }
        };
    },

    // æŠ•è³‡é¡ (é¢¨éšªåˆ¶)
    invest: () => {
        const risk = randInt(10, 100);
        let riskTag = 'risk-low';
        let riskText = 'ä½é¢¨éšª';
        if (risk > 50) { riskTag = 'risk-mid'; riskText = 'ä¸­é¢¨éšª'; }
        if (risk > 80) { riskTag = 'risk-high'; riskText = 'é«˜é¢¨éšª'; }

        const cost = randInt(50, 100);
        // é¢¨éšªè¶Šé«˜ï¼Œæ½›åœ¨å›å ±è¶Šé«˜ï¼Œä½†ä¹Ÿå¯èƒ½è³ éŒ¢
        const maxRoi = 120 + Math.floor(risk * 1.5); // 120% ~ 270%
        const wait = randInt(2, 4);

        return {
            title: 'ğŸš€ æŠ•è³‡æ©Ÿæœƒ',
            tag: riskText,
            riskLevel: riskTag, // ç”¨æ–¼ UI é¡è‰²
            desc: `æŠ•å…¥ $${cost}ï¼Œ${wait} è¼ªå¾Œçµç®—ã€‚é¢¨éšªå€¼: ${risk} (å¯èƒ½å°è‡´è™§æ)ã€‚`,
            effect: (p) => {
                if (p.cash < cost) return 'ç¾é‡‘ä¸è¶³ç„¡æ³•æŠ•è³‡';
                p.cash -= cost;
                p.investments.push({
                    cost: cost,
                    maxRoi: maxRoi,
                    risk: risk,
                    turnsLeft: wait
                });
                return `æŠ•å…¥è³‡é‡‘ $${cost}`;
            }
        };
    },
    
    // ä¼‘æ¯ (æ¢å¾©å¥åº·)
    rest: () => ({
        title: 'ğŸ§˜ æ·±åº¦ä¼‘æ¯',
        tag: 'å¥åº·',
        desc: 'èŠ±è²» $20 é€²è¡Œèª¿é¤Šï¼Œæ¢å¾© 15 é»å¥åº·å€¼ã€‚',
        effect: (p) => {
            if (p.cash < 20) return 'æ²’éŒ¢ä¼‘æ¯';
            p.cash -= 20;
            let heal = 15;
            p.hp = Math.min(CONFIG.maxHp, p.hp + heal);
            return `å¥åº·æ¢å¾© +${heal}`;
        }
    })
};

function generateCards(playerIdx) {
    let pool = [];
    
    // å»ºæ§‹ç‰Œåº«æ¬Šé‡
    // 1. å·¥ä½œ (ç¢ºä¿æœ‰æ©Ÿæœƒæ›å·¥ä½œ)
    pool.push(generators.jobStableStandard);
    pool.push(generators.jobStableStandard);
    pool.push(generators.jobStableShift);
    pool.push(generators.jobStableOvertime);
    
    // 2. å…¼è·
    pool.push(generators.jobPartTime);
    pool.push(generators.jobPartTime);

    // 3. éŠ€è¡Œèˆ‡æŠ•è³‡
    pool.push(generators.deposit); 
    pool.push(generators.deposit);
    pool.push(generators.deposit); // å¤šä¸€é»å­˜éŒ¢æ©Ÿæœƒ
    pool.push(generators.withdraw);
    pool.push(generators.rateBoost);
    pool.push(generators.rateBoost);
    
    pool.push(generators.invest);
    pool.push(generators.invest);
    pool.push(generators.invest);

    // 4. å¥åº·
    pool.push(generators.rest);

    // æ´—ç‰ŒæŠ½ 5 å¼µ
    let deck = [];
    for(let i=0; i<5; i++) {
        let gen = pool[Math.floor(Math.random() * pool.length)];
        deck.push(gen());
    }
    
    gameState.currentCards = deck;
    renderCards();
}

function renderCards() {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';
    
    gameState.currentCards.forEach((card, idx) => {
        let isSelected = gameState.selectedCardIndices.includes(idx);
        let div = document.createElement('div');
        div.className = `card ${isSelected ? 'selected' : ''}`;
        
        // Tag Color logic
        let tagClass = 'tag-none';
        if (card.tag.includes('é¢¨éšª')) tagClass = `tag-${card.riskLevel}`;
        else if (card.tag.includes('å·¥ä½œ') || card.tag.includes('å…¼è·')) tagClass = 'tag-job';
        else if (card.tag.includes('å¥åº·')) tagClass = 'tag-risk-low';

        div.innerHTML = `
            <div>
                <div class="card-header">
                    <div class="card-title">${card.title}</div>
                    <span class="tag ${tagClass}">${card.tag}</span>
                </div>
                <div class="card-desc">${card.desc}</div>
            </div>
        `;
        div.onclick = () => handleCardClick(idx);
        container.appendChild(div);
    });
}

// --- çµç®—æ ¸å¿ƒ ---
function processTurn() {
    log(`--- ç¬¬ ${gameState.turn} è¼ªçµç®— ---`, 'turn');
    
    handleGlobalEvents();

    gameState.players.forEach(p => {
        let logs = [];
        p.roundIncome = 0;

        // 1. è¨ˆç®—å·¥æ™‚èˆ‡å¥åº·
        let dailyHours = 0;
        if (p.stableJob) dailyHours += p.stableJob.hours;
        p.partTimeJobs.forEach(j => dailyHours += j.hours);
        
        if (dailyHours > CONFIG.safeHours) {
            let over = dailyHours - CONFIG.safeHours;
            let dmg = over * CONFIG.overworkPenalty;
            p.hp -= dmg;
            logs.push(`<span class="log-bad">éå‹(${dailyHours}hr) å¥åº· -${dmg}</span>`);
        }

        // 2. ç”Ÿç—…åˆ¤å®š
        // å¥åº· 100 -> 0% æ©Ÿç‡, å¥åº· 0 -> 50% æ©Ÿç‡
        let sickChance = (100 - p.hp) * 0.5 / 100;
        if (Math.random() < sickChance) {
            let cost = 100;
            p.cash -= cost;
            p.hp = Math.min(CONFIG.maxHp, p.hp + 5);
            logs.push(`<span class="log-bad">ğŸ¤’ é«”åŠ›ä¸æ”¯é€é†« -$${cost} (å¥åº·+5)</span>`);
        }

        // 3. æ”¶å…¥çµç®—
        if (p.stableJob) {
            p.roundIncome += p.stableJob.pay;
            p.cash += p.stableJob.pay;
        }
        
        // å…¼è·
        p.partTimeJobs.forEach(j => {
            p.roundIncome += j.pay;
            p.cash += j.pay;
            j.turnsLeft--;
        });
        p.partTimeJobs = p.partTimeJobs.filter(j => j.turnsLeft > 0);

        // 4. æŠ•è³‡çµç®— (å«é¢¨éšª)
        p.investments.forEach(inv => {
            inv.turnsLeft--;
            if (inv.turnsLeft === 0) {
                // çµç®—é‚è¼¯
                let roll = Math.random() * 100; // 0-99
                let resultAmt = 0;
                
                // ç°¡å–®é¢¨éšªæ¨¡å‹ï¼šRisk 80 => 80% æ©Ÿç‡å¯èƒ½æœ‰å£äº‹ï¼Œæˆ–è€…æ³¢å‹•å¤§
                // é€™è£¡æ¡ç”¨ï¼šRisk è¶Šé«˜ï¼Œæ³¢å‹•ç¯„åœè¶Šå¤§ (å¯èƒ½å¤§è³ºæˆ–è³ æœ¬)
                // åŸºæº–å›å ± 100% (ä¿æœ¬)
                
                // æ³¢å‹•å› å­ï¼šRisk 0 -> +/- 5%, Risk 100 -> +/- 150%
                let volatility = inv.risk * 1.5; 
                let actualReturnRate = 100 + (Math.random() * volatility * 2 - volatility); 
                // åŠ ä¸Š maxRoi çš„ä¸€é»æ¬Šé‡
                
                // ç°¡åŒ–ç‰ˆï¼š
                // å¦‚æœ Roll < Risk/2ï¼Œå‰‡è™§æã€‚å¦å‰‡ç²åˆ©ã€‚
                if (roll < (inv.risk / 2.5)) {
                    // è™§æäº‹ä»¶
                    let lossRate = randInt(10, 50 + inv.risk/2); // è™§ 10% ~ 100%
                    if (inv.risk > 80 && Math.random() < 0.2) lossRate = 150; // çˆ†å€‰è² å‚µ
                    
                    let returnVal = Math.floor(inv.cost * (100 - lossRate) / 100);
                    resultAmt = returnVal - inv.cost; // æ·¨åˆ© (è² æ•¸)
                    p.cash += returnVal; // é€€å›å‰©é¤˜æœ¬é‡‘
                    logs.push(`<span class="log-bad">æŠ•è³‡å¤±åˆ©(R:${inv.risk}) è™§æ $${-resultAmt + inv.cost - returnVal}</span>`);
                } else {
                    // ç²åˆ©
                    let profitRate = randInt(10, inv.maxRoi - 100);
                    let totalBack = Math.floor(inv.cost * (100 + profitRate) / 100);
                    p.cash += totalBack;
                    logs.push(`<span class="log-good">æŠ•è³‡ç²åˆ©(R:${inv.risk}) +$${totalBack - inv.cost}</span>`);
                    p.roundIncome += (totalBack - inv.cost);
                }
            }
        });
        p.investments = p.investments.filter(i => i.turnsLeft > 0);

        // 5. å¼·åˆ¶æ”¯å‡º (åä¸€ + ç”Ÿæ´»è²»)
        if (p.roundIncome > 0) {
            let tithe = Math.floor(p.roundIncome * CONFIG.titheRate);
            p.cash -= tithe;
            logs.push(`åä¸€å¥‰ç» -$${tithe}`);
        }
        p.cash -= CONFIG.livingCost;

        // 6. åˆ©æ¯
        let currentRate = p.rate + p.tempRateBoost;
        let interest = Math.floor(p.bank * currentRate);
        if (interest > 0) {
            p.bank += interest;
            logs.push(`åˆ©æ¯ +$${interest}`);
        }
        p.tempRateBoost = 0;

        // 7. ç ´ç”¢è™•ç†
        if (p.cash < 0) {
            if (p.bank >= -p.cash) {
                p.bank += p.cash; // cash is negative
                p.cash = 0;
                logs.push(`è‡ªå‹•è½‰å¸³è£œèµ¤å­—`);
            } else {
                p.cash += p.bank;
                p.bank = 0;
                logs.push(`<span class="log-bad">è² å‚µç´¯ç´¯ $${p.cash}</span>`);
            }
        }
        
        // é™åˆ¶ HP ç¯„åœ
        if (p.hp < 0) p.hp = 0;

        if (logs.length) log(`${p.name}: ${logs.join(', ')}`);
    });

    gameState.turn++;
    if (gameState.turn > CONFIG.maxTurns) {
        endGame();
    } else {
        startPlayerTurn(0);
    }
}

function handleGlobalEvents() {
    // ç¬¬ 5 è¼ªå¾ŒåŠ å…¥éš¨æ©Ÿä»˜æ¬¾äº‹ä»¶
    if (gameState.turn > 5 && Math.random() < 0.4) {
        const bills = [
            { t: 'ğŸ’¸ æ”¶åˆ°ç‡ƒæ–™ç¨…å–®', amt: 30 },
            { t: 'âš¡ å¤å­£é›»è²»å¸³å–®', amt: 25 },
            { t: 'ğŸš— æ©Ÿè»Šå¼·åˆ¶éšªçºŒä¿', amt: 15 },
            { t: 'ğŸ“± æ‰‹æ©Ÿè¢å¹•æ‘”å£', amt: 40 }
        ];
        let bill = bills[randInt(0, bills.length-1)];
        log(`[å¸³å–®] ${bill.t} -$${bill.amt}`, 'event');
        gameState.players.forEach(p => p.cash -= bill.amt);
    }
}

// --- è¼”åŠ©å‡½å¼ ---
function updateUI() {
    document.getElementById('turn-display').innerText = `ç¬¬ ${gameState.turn} / ${CONFIG.maxTurns} è¼ª`;
    
    const phases = {
        'p1_choice': 'A çµ„é¸æ“‡ (è«‹é¸ 2 å¼µ)',
        'p2_choice': 'B çµ„é¸æ“‡ (è«‹é¸ 2 å¼µ)',
        'processing': 'çµç®—ä¸­...'
    };
    document.getElementById('phase-msg').innerText = phases[gameState.phase];

    updatePlayerUI(0, 'p1');
    updatePlayerUI(1, 'p2');

    document.getElementById('p1-stats').classList.toggle('active', gameState.phase === 'p1_choice');
    document.getElementById('p2-stats').classList.toggle('active', gameState.phase === 'p2_choice');
}

function updatePlayerUI(idx, prefix) {
    let p = gameState.players[idx];
    
    // é‡‘éŒ¢
    let cashEl = document.getElementById(`${prefix}-cash`);
    cashEl.innerText = `$${p.cash}`;
    cashEl.className = p.cash < 0 ? 'money debt' : 'money';
    document.getElementById(`${prefix}-bank`).innerText = `$${p.bank}`;
    
    // å¥åº·
    document.getElementById(`${prefix}-hp-text`).innerText = Math.floor(p.hp);
    let hpBar = document.getElementById(`${prefix}-hp-bar`);
    hpBar.style.width = `${Math.max(0, p.hp)}%`;
    if (p.hp < 30) hpBar.style.background = '#e74c3c';
    else if (p.hp < 70) hpBar.style.background = '#f39c12';
    else hpBar.style.background = '#27ae60';

    // åˆ©ç‡
    let finalRate = (p.rate + p.tempRateBoost) * 100;
    document.getElementById(`${prefix}-rate`).innerText = `${finalRate.toFixed(1)}%`;

    // ç‹€æ…‹æè¿°
    let statusParts = [];
    if (p.stableJob) statusParts.push(p.stableJob.name);
    else statusParts.push("å¾…æ¥­ä¸­");
    
    if (p.partTimeJobs.length > 0) statusParts.push(`å…¼è·x${p.partTimeJobs.length}`);
    if (p.investments.length > 0) statusParts.push(`æŠ•è³‡x${p.investments.length}`);
    
    document.getElementById(`${prefix}-status`).innerText = statusParts.join(' | ');
}

function endGame() {
    let p1Total = gameState.players[0].cash + gameState.players[0].bank + getAssets(gameState.players[0]);
    let p2Total = gameState.players[1].cash + gameState.players[1].bank + getAssets(gameState.players[1]);
    
    let winner = p1Total > p2Total ? "ğŸ† A çµ„ç²å‹ï¼" : (p2Total > p1Total ? "ğŸ† B çµ„ç²å‹ï¼" : "ğŸ¤ å¹³æ‰‹ï¼");

    let html = `
        <div style="text-align:center; background:white; padding:30px; border-radius:10px;">
            <h1 style="color:#e67e22">${winner}</h1>
            <div style="display:flex; justify-content:space-around; margin:20px 0;">
                <div>
                    <h3>A çµ„ç¸½è³‡ç”¢</h3>
                    <div style="font-size:2em; color:#27ae60">$${p1Total}</div>
                    <small>å¥åº·: ${Math.floor(gameState.players[0].hp)}</small>
                </div>
                <div>
                    <h3>B çµ„ç¸½è³‡ç”¢</h3>
                    <div style="font-size:2em; color:#27ae60">$${p2Total}</div>
                    <small>å¥åº·: ${Math.floor(gameState.players[1].hp)}</small>
                </div>
            </div>
            <button class="confirm-btn" onclick="location.reload()">å†ä¾†ä¸€å±€</button>
        </div>
    `;
    document.getElementById('cards-container').innerHTML = html;
    document.getElementById('confirm-btn').style.display = 'none';
}

function getAssets(p) {
    // ç°¡å–®è¨ˆç®—ï¼šæœªåˆ°æœŸçš„æŠ•è³‡ç®— 50% åƒ¹å€¼ (æ€¥å”®)
    let val = 0;
    p.investments.forEach(i => val += Math.floor(i.cost * 0.5));
    return val;
}

function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function log(msg, type='') {
    const area = document.getElementById('game-log');
    const div = document.createElement('div');
    div.className = 'log-entry';
    if (type === 'turn') div.innerHTML = `<span class="log-turn">${msg}</span>`;
    else div.innerHTML = msg;
    area.prepend(div);
}
</script>
</body>
</html>
